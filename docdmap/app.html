<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #canvas {
            width: 100vw;
            height: 100vh;
            position: relative;
            cursor: grab;
        }

        #canvas.grabbing {
            cursor: grabbing;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .node {
            position: absolute;
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            min-width: 200px;
            max-width: 800px;
            min-height: 100px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: move;
            z-index: 2;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.3s, background-color 0.3s;
            resize: none;
            display: flex;
            flex-direction: column;
        }

        .node:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .node.dragging {
            opacity: 0.8;
            z-index: 1000;
        }

        .node.selected {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
        }

        .node.resizing {
            transition: none;
        }

        .node.resizing:hover {
            transform: none;
        }

        .view-mode {
            flex: 1;
            overflow: auto;
        }

        /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 11;
        }

        .resize-handle.top {
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
        }

        .resize-handle.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
        }

        .resize-handle.left {
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
        }

        .resize-handle.right {
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
        }

        .resize-handle:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        /* ã‚³ãƒã‚¯ã‚¿ãƒ¼ */
        .connector {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            opacity: 0;
        }

        .node:hover .connector {
            opacity: 1;
        }

        .connector:hover {
            width: 16px;
            height: 16px;
            background: #5568d3;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.6);
        }

        .connector.active {
            opacity: 1;
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
        }

        .connector.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connector.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connector.left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connector.right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connector.top:hover,
        .connector.top.active {
            transform: translateX(-50%) scale(1.3);
        }

        .connector.bottom:hover,
        .connector.bottom.active {
            transform: translateX(-50%) scale(1.3);
        }

        .connector.left:hover,
        .connector.left.active {
            transform: translateY(-50%) scale(1.3);
        }

        .connector.right:hover,
        .connector.right.active {
            transform: translateY(-50%) scale(1.3);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ */
        .node.status-OK {
            border-color: #2ecc71;
            border-width: 3px;
        }

        .node.status-NG {
            border-color: #e74c3c;
            border-width: 3px;
        }

        .node.status-å´ä¸‹ {
            background-color: #e0e0e0;
        }

        .node.status-ä¿ç•™ {
            background-color: #e6d5f5;
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            gap: 10px;
        }

        .node-left-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 80px;
        }

        .node-id-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        /* ãƒ†ã‚¹ãƒˆç¨®åˆ¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
        .test-type {
            padding: 4px 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            width: 100%;
        }

        .test-type:focus {
            outline: none;
            border-color: #5568d3;
        }

        .test-type.type-æ­£å¸¸ç³» {
            background-color: #2ecc71;
            color: white;
            border-color: #27ae60;
        }

        .test-type.type-ç•°å¸¸ç³» {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .test-type.type-ãã®ä»– {
            background-color: #95a5a6;
            color: white;
            border-color: #7f8c8d;
        }

        .node-id {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
            min-width: 60px;
            padding: 4px 8px;
            background: #f0f4ff;
            border-radius: 4px;
            cursor: text;
            border: 1px solid transparent;
            transition: all 0.2s;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .node-id:hover {
            border-color: #667eea;
        }

        .node-id:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .node-status {
            padding: 4px 10px;
            border: 2px solid #667eea;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            width: 100%;
        }

        .node-status:hover {
            background: #f0f4ff;
        }

        .node-status:focus {
            outline: none;
            border-color: #5568d3;
        }

        .node-status.status-èµ·ç¥¨ {
            border-color: #95a5a6;
            color: #95a5a6;
        }

        .node-status.status-OK {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .node-status.status-NG {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .node-status.status-å´ä¸‹ {
            border-color: #95a5a6;
            color: #95a5a6;
        }

        .node-status.status-ä¿ç•™ {
            border-color: #95a5a6;
            color: #95a5a6;
        }

        .node-controls {
            display: flex;
            gap: 5px;
        }

        .node-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .node-btn:hover {
            background: #5568d3;
        }

        .node-btn.delete {
            background: #ff6b6b;
        }

        .node-btn.delete:hover {
            background: #ee5a52;
        }

        .node-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .node-content:hover {
            background-color: #f8f9fa;
        }

        .node-content h1 { font-size: 1.5em; margin: 0.5em 0; word-wrap: break-word; }
        .node-content h2 { font-size: 1.3em; margin: 0.5em 0; word-wrap: break-word; }
        .node-content h3 { font-size: 1.1em; margin: 0.5em 0; word-wrap: break-word; }
        .node-content p { margin: 0.5em 0; word-wrap: break-word; }
        .node-content ul, .node-content ol { margin-left: 1.5em; }
        .node-content li { word-wrap: break-word; }
        .node-content code { 
            background: #f4f4f4; 
            padding: 2px 6px; 
            border-radius: 3px;
            font-family: monospace;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        .node-content pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .node-content pre code {
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .node-content strong { font-weight: bold; }
        .node-content em { font-style: italic; }

        .edit-mode {
            display: none;
            height: 100%;
        }

        .node.editing .edit-mode {
            display: flex;
            flex-direction: column;
        }

        .node.editing .view-mode {
            display: none;
        }

        .node-textarea {
            width: 100%;
            height: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            resize: none;
            box-sizing: border-box;
        }

        .toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .toolbar button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            margin-right: 10px;
        }

        .toolbar button:hover {
            background: #5568d3;
        }

        .info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 12px;
            color: #333;
            max-width: 300px;
        }

        .info h3 {
            margin-bottom: 8px;
            color: #667eea;
            font-size: 14px;
        }

        .info ul {
            list-style: none;
            padding: 0;
        }

        .info li {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .info li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #667eea;
        }

        .connection {
            stroke: white;
            stroke-width: 2;
            opacity: 0.8;
            pointer-events: stroke;
            cursor: pointer;
        }

        .connection:hover {
            stroke-width: 4;
            opacity: 1;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 150px;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: #f0f4ff;
        }

        .context-menu-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        .context-menu-item.delete {
            color: #e74c3c;
            font-weight: 500;
        }

        .context-menu-item.delete:hover {
            background: #fee;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="addNodeBtn">â• ãƒãƒ¼ãƒ‰è¿½åŠ </button>
        <button id="clearBtn">ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="info">
        <h3>ğŸ“ æ“ä½œæ–¹æ³•</h3>
        <ul>
            <li>ãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•</li>
            <li>ãƒãƒ¼ãƒ‰ã®4è¾ºã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒªã‚µã‚¤ã‚º</li>
            <li>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹IDã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†</li>
            <li>ç¨®åˆ¥ã§æ­£å¸¸ç³»/ç•°å¸¸ç³»ã‚’é¸æŠ</li>
            <li>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒãƒ¼ãƒ‰ã®è¦‹ãŸç›®ãŒå¤‰åŒ–</li>
            <li>ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³éƒ¨åˆ†ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†</li>
            <li>ç·¨é›†ä¸­ã¯å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•ä¿å­˜</li>
            <li>ãƒãƒ¼ãƒ‰ã®4æ–¹å‘ã®ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¥ç¶š</li>
            <li>ãƒãƒ¼ãƒ‰ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤</li>
            <li>æ¥ç¶šç·šã‚’å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤</li>
            <li>èƒŒæ™¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å…¨ä½“ç§»å‹•</li>
        </ul>
    </div>

    <div id="canvas">
        <svg id="svg"></svg>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item delete" id="deleteNode">ğŸ—‘ï¸ ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤</div>
        <div class="context-menu-item delete" id="deleteConnection">ğŸ—‘ï¸ æ¥ç¶šã‚’å‰Šé™¤</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const svg = document.getElementById('svg');
        const addNodeBtn = document.getElementById('addNodeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const contextMenu = document.getElementById('contextMenu');
        const deleteNodeBtn = document.getElementById('deleteNode');
        const deleteConnectionBtn = document.getElementById('deleteConnection');

        let nodes = [];
        let connections = [];
        let nodeIdCounter = 0;
        let isDraggingCanvas = false;
        let dragStart = { x: 0, y: 0 };
        let selectedConnection = null;
        let selectedNode = null;
        let connectingFrom = null;

        // ãƒãƒ¼ãƒ‰ä½œæˆ
        function createNode(x, y, content = '# æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹\n\nå†…å®¹ã‚’è¨˜è¿°...') {
            const nodeId = nodeIdCounter++;
            const node = document.createElement('div');
            node.className = 'node';
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            
            node.innerHTML = `
                <div class="resize-handle top"></div>
                <div class="resize-handle bottom"></div>
                <div class="resize-handle left"></div>
                <div class="resize-handle right"></div>
                <div class="connector top" data-direction="top"></div>
                <div class="connector bottom" data-direction="bottom"></div>
                <div class="connector left" data-direction="left"></div>
                <div class="connector right" data-direction="right"></div>
                <div class="node-header">
                    <div class="node-left-section">
                        <select class="test-type type-æ­£å¸¸ç³»">
                            <option value="æ­£å¸¸ç³»">æ­£å¸¸ç³»</option>
                            <option value="ç•°å¸¸ç³»">ç•°å¸¸ç³»</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                        <select class="node-status status-èµ·ç¥¨">
                            <option value="èµ·ç¥¨">èµ·ç¥¨</option>
                            <option value="OK">OK</option>
                            <option value="NG">NG</option>
                            <option value="å´ä¸‹">å´ä¸‹</option>
                            <option value="ä¿ç•™">ä¿ç•™</option>
                        </select>
                    </div>
                    <div class="node-id-container">
                        <div class="node-id" contenteditable="true">TC-${String(nodeId + 1).padStart(3, '0')}</div>
                    </div>
                </div>
                <div class="view-mode">
                    <div class="node-content"></div>
                </div>
                <div class="edit-mode">
                    <textarea class="node-textarea">${content}</textarea>
                </div>
            `;

            const nodeData = {
                id: nodeId,
                element: node,
                x: x,
                y: y,
                width: null,
                height: null,
                content: content,
                testCaseId: `TC-${String(nodeId + 1).padStart(3, '0')}`,
                status: 'èµ·ç¥¨',
                testType: 'æ­£å¸¸ç³»'
            };

            nodes.push(nodeData);
            canvas.appendChild(node);

            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            updateNodeContent(nodeData);

            // åˆæœŸã‚µã‚¤ã‚ºã‚’è¨˜éŒ²
            setTimeout(() => {
                if (!nodeData.width) {
                    nodeData.width = node.offsetWidth;
                }
                if (!nodeData.height) {
                    nodeData.height = node.offsetHeight;
                }
            }, 0);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            setupNodeEvents(nodeData);

            return nodeData;
        }

        // ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
        function updateNodeContent(nodeData) {
            const contentDiv = nodeData.element.querySelector('.node-content');
            contentDiv.innerHTML = marked.parse(nodeData.content);
        }

        // ãƒãƒ¼ãƒ‰ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        function updateNodeAppearance(nodeData) {
            const node = nodeData.element;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ãƒãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã®æ›´æ–°
            node.classList.remove('status-èµ·ç¥¨', 'status-OK', 'status-NG', 'status-å´ä¸‹', 'status-ä¿ç•™');
            node.classList.add(`status-${nodeData.status}`);
        }

        // ãƒãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupNodeEvents(nodeData) {
            const node = nodeData.element;
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };

            // ãƒ†ã‚¹ãƒˆç¨®åˆ¥å¤‰æ›´
            const testTypeSelect = node.querySelector('.test-type');
            testTypeSelect.addEventListener('change', (e) => {
                nodeData.testType = e.target.value;
                testTypeSelect.className = `test-type type-${e.target.value}`;
            });

            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹IDç·¨é›†
            const nodeIdInput = node.querySelector('.node-id');
            nodeIdInput.addEventListener('blur', () => {
                nodeData.testCaseId = nodeIdInput.textContent;
            });

            nodeIdInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    nodeIdInput.blur();
                }
            });

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
            const statusSelect = node.querySelector('.node-status');
            statusSelect.addEventListener('change', (e) => {
                nodeData.status = e.target.value;
                statusSelect.className = `node-status status-${e.target.value}`;
                updateNodeAppearance(nodeData);
            });

            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
            node.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON' || 
                    e.target.tagName === 'TEXTAREA' || 
                    e.target.tagName === 'SELECT' || 
                    e.target.classList.contains('node-id') ||
                    e.target.classList.contains('connector') ||
                    e.target.classList.contains('resize-handle')) return;
                
                isDragging = true;
                node.classList.add('dragging');
                dragOffset.x = e.clientX - nodeData.x;
                dragOffset.y = e.clientY - nodeData.y;
                e.stopPropagation();
            });

            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³éƒ¨åˆ†ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
            const contentDiv = node.querySelector('.node-content');
            contentDiv.addEventListener('dblclick', () => {
                // ç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’å–å¾—ã—ã¦å›ºå®š
                const currentWidth = node.offsetWidth;
                const currentHeight = node.offsetHeight;
                
                // ãƒãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®š
                if (!nodeData.width || nodeData.width < currentWidth) {
                    nodeData.width = currentWidth;
                }
                if (!nodeData.height || nodeData.height < currentHeight) {
                    nodeData.height = currentHeight;
                }
                
                node.style.width = nodeData.width + 'px';
                node.style.height = nodeData.height + 'px';
                
                node.classList.add('editing');
                const textarea = node.querySelector('.node-textarea');
                textarea.focus();
            });

            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜
            const textarea = node.querySelector('.node-textarea');
            document.addEventListener('click', (e) => {
                if (node.classList.contains('editing')) {
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¨ãã®è¦ªè¦ç´ ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
                    if (!textarea.contains(e.target) && !node.contains(e.target)) {
                        nodeData.content = textarea.value;
                        updateNodeContent(nodeData);
                        node.classList.remove('editing');
                    } else if (node.contains(e.target) && !textarea.contains(e.target) && e.target.tagName !== 'TEXTAREA') {
                        // ãƒãƒ¼ãƒ‰å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
                        nodeData.content = textarea.value;
                        updateNodeContent(nodeData);
                        node.classList.remove('editing');
                    }
                }
            });

            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            const resizeHandles = node.querySelectorAll('.resize-handle');
            resizeHandles.forEach(handle => {
                let isResizing = false;
                let resizeStartX = 0;
                let resizeStartY = 0;
                let startWidth = 0;
                let startHeight = 0;
                let startX = 0;
                let startY = 0;

                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    isResizing = true;
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    startWidth = node.offsetWidth;
                    startHeight = node.offsetHeight;
                    startX = nodeData.x;
                    startY = nodeData.y;
                    node.classList.add('resizing');

                    const handleMouseMove = (e) => {
                        if (!isResizing) return;

                        const deltaX = e.clientX - resizeStartX;
                        const deltaY = e.clientY - resizeStartY;

                        if (handle.classList.contains('right')) {
                            const newWidth = Math.max(200, startWidth + deltaX);
                            node.style.width = newWidth + 'px';
                            nodeData.width = newWidth;
                        } else if (handle.classList.contains('left')) {
                            const newWidth = Math.max(200, startWidth - deltaX);
                            if (newWidth > 200) {
                                node.style.width = newWidth + 'px';
                                nodeData.width = newWidth;
                                nodeData.x = startX + deltaX;
                                node.style.left = nodeData.x + 'px';
                            }
                        } else if (handle.classList.contains('bottom')) {
                            const newHeight = Math.max(100, startHeight + deltaY);
                            node.style.height = newHeight + 'px';
                            nodeData.height = newHeight;
                        } else if (handle.classList.contains('top')) {
                            const newHeight = Math.max(100, startHeight - deltaY);
                            if (newHeight > 100) {
                                node.style.height = newHeight + 'px';
                                nodeData.height = newHeight;
                                nodeData.y = startY + deltaY;
                                node.style.top = nodeData.y + 'px';
                            }
                        }

                        updateConnections();
                    };

                    const handleMouseUp = () => {
                        if (isResizing) {
                            isResizing = false;
                            node.classList.remove('resizing');
                            document.removeEventListener('mousemove', handleMouseMove);
                            document.removeEventListener('mouseup', handleMouseUp);
                        }
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            });

            // ãƒãƒ¼ãƒ‰ã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            node.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectedNode = nodeData;
                selectedConnection = null;
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.style.top = e.clientY + 'px';
                contextMenu.classList.add('show');
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®è¡¨ç¤º/éè¡¨ç¤º
                deleteNodeBtn.style.display = 'block';
                deleteConnectionBtn.style.display = 'none';
            });

            // ã‚³ãƒã‚¯ã‚¿ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const connectors = node.querySelectorAll('.connector');
            connectors.forEach(connector => {
                connector.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleConnectorClick(nodeData, connector);
                });
            });

            // ãƒã‚¦ã‚¹ç§»å‹•
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    nodeData.x = e.clientX - dragOffset.x;
                    nodeData.y = e.clientY - dragOffset.y;
                    node.style.left = nodeData.x + 'px';
                    node.style.top = nodeData.y + 'px';
                    updateConnections();
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    node.classList.remove('dragging');
                }
            });
        }

        // ãƒãƒ¼ãƒ‰å‰Šé™¤
        function deleteNode(nodeData) {
            nodeData.element.remove();
            nodes = nodes.filter(n => n.id !== nodeData.id);
            connections = connections.filter(c => c.from !== nodeData.id && c.to !== nodeData.id);
            updateConnections();
        }

        // æ¥ç¶šä½œæˆ
        function createConnection(fromNodeId, toNodeId) {
            connections.push({ from: fromNodeId, to: toNodeId });
            updateConnections();
        }

        // ã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleConnectorClick(nodeData, connector) {
            if (!connectingFrom) {
                // æ¥ç¶šé–‹å§‹
                connectingFrom = nodeData;
                connector.classList.add('active');
            } else {
                // æ¥ç¶šå®Œäº†
                if (connectingFrom.id !== nodeData.id) {
                    createConnection(connectingFrom.id, nodeData.id);
                }
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è§£é™¤
                const activeConnectors = document.querySelectorAll('.connector.active');
                activeConnectors.forEach(c => c.classList.remove('active'));
                connectingFrom = null;
            }
        }

        // æ¥ç¶šæ›´æ–°
        function updateConnections() {
            svg.innerHTML = '';
            connections.forEach((conn, index) => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (fromNode && toNode) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    
                    const fromRect = fromNode.element.getBoundingClientRect();
                    const toRect = toNode.element.getBoundingClientRect();
                    
                    const fromX = fromNode.x + fromRect.width / 2;
                    const fromY = fromNode.y + fromRect.height / 2;
                    const toX = toNode.x + toRect.width / 2;
                    const toY = toNode.y + toRect.height / 2;
                    
                    line.setAttribute('x1', fromX);
                    line.setAttribute('y1', fromY);
                    line.setAttribute('x2', toX);
                    line.setAttribute('y2', toY);
                    line.classList.add('connection');
                    line.dataset.connectionIndex = index;
                    
                    // å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    line.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        selectedConnection = index;
                        selectedNode = null;
                        contextMenu.style.left = e.clientX + 'px';
                        contextMenu.style.top = e.clientY + 'px';
                        contextMenu.classList.add('show');
                        
                        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®è¡¨ç¤º/éè¡¨ç¤º
                        deleteNodeBtn.style.display = 'none';
                        deleteConnectionBtn.style.display = 'block';
                    });
                    
                    svg.appendChild(line);
                }
            });
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        addNodeBtn.addEventListener('click', () => {
            createNode(Math.random() * 600 + 100, Math.random() * 400 + 100);
        });

        clearBtn.addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                nodes.forEach(n => n.element.remove());
                nodes = [];
                connections = [];
                updateConnections();
            }
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒãƒ¼ãƒ‰å‰Šé™¤
        deleteNodeBtn.addEventListener('click', () => {
            if (selectedNode !== null) {
                if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    deleteNode(selectedNode);
                    contextMenu.classList.remove('show');
                    selectedNode = null;
                }
            }
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ¥ç¶šå‰Šé™¤
        deleteConnectionBtn.addEventListener('click', () => {
            if (selectedConnection !== null) {
                connections.splice(selectedConnection, 1);
                updateConnections();
                contextMenu.classList.remove('show');
                selectedConnection = null;
            }
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.classList.remove('show');
            }
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒªã‚µã‚¤ã‚ºã§é–‰ã˜ã‚‹
        window.addEventListener('scroll', () => {
            contextMenu.classList.remove('show');
        });

        window.addEventListener('resize', () => {
            contextMenu.classList.remove('show');
        });

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‰ãƒ©ãƒƒã‚°
        canvas.addEventListener('mousedown', (e) => {
            if (e.target === canvas || e.target === svg) {
                isDraggingCanvas = true;
                canvas.classList.add('grabbing');
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingCanvas) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                
                nodes.forEach(nodeData => {
                    nodeData.x += dx;
                    nodeData.y += dy;
                    nodeData.element.style.left = nodeData.x + 'px';
                    nodeData.element.style.top = nodeData.y + 'px';
                });
                
                updateConnections();
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
            }
        });

        document.addEventListener('mouseup', () => {
            isDraggingCanvas = false;
            canvas.classList.remove('grabbing');
        });

        // åˆæœŸãƒãƒ¼ãƒ‰ä½œæˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        const node1 = createNode(200, 150, '# ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ\n\n## å‰ææ¡ä»¶\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²æ¸ˆã¿\n- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹\n\n## ãƒ†ã‚¹ãƒˆæ‰‹é †\n1. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›\n2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›\n3. ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n\n## æœŸå¾…çµæœ\nãƒ›ãƒ¼ãƒ ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹');
        const node2 = createNode(550, 100, '# æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ\n\n## æ‰‹é †\n- æœ‰åŠ¹ãªID/PWã‚’å…¥åŠ›\n\n## çµæœ\n**æˆåŠŸ**ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹');
        const node3 = createNode(550, 300, '# ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ\n\n## æ‰‹é †\n- ç„¡åŠ¹ãªPWã‚’å…¥åŠ›\n\n## çµæœ\n`ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`ãŒè¡¨ç¤ºã•ã‚Œã‚‹');
        
        // åˆæœŸãƒãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã‚’è¨­å®š
        node2.testType = 'æ­£å¸¸ç³»';
        node2.element.querySelector('.test-type').value = 'æ­£å¸¸ç³»';
        node2.element.querySelector('.test-type').className = 'test-type type-æ­£å¸¸ç³»';
        
        node3.testType = 'ç•°å¸¸ç³»';
        node3.element.querySelector('.test-type').value = 'ç•°å¸¸ç³»';
        node3.element.querySelector('.test-type').className = 'test-type type-ç•°å¸¸ç³»';
        
        createConnection(node1.id, node2.id);
        createConnection(node1.id, node3.id);
    </script>
</body>
</html>